services:
  db_test:
    image: postgres:16
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_DB: app_test
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d app_test"]
      interval: 2s
      timeout: 2s
      retries: 30

  redis_test:
    image: redis:7
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 2s
      retries: 30

  tests:
    build:
      context: .
      dockerfile: docker/Dockerfile
    environment:
      APP_ENV: test
      DATABASE_URL: postgresql+psycopg://app:app@db_test:5432/app_test
      REDIS_URL: redis://redis_test:6379/0
      JWT_SECRET: test-secret
      MAGIC_LINK_PEPPER: test-pepper
      PYTHONPATH: /app
    depends_on:
      db_test:
        condition: service_healthy
      redis_test:
        condition: service_healthy
    command: pytest -q
